<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>订单来源桑基图</title>
    <!-- 1. 引入 ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
<!-- 2. 准备一个容器 -->
<div id="sankey-chart" style="width: 100%; height: 100vh;"></div>

<script type="text/javascript">
    console.log(123);
    // 3. 初始化 ECharts 实例
    var myChart = echarts.init(document.getElementById('sankey-chart'));

    // 显示加载动画
    myChart.showLoading();

    // 4. 使用 fetch 从后端 API 获取数据
    fetch('/api/sankey-data')
        .then(response => {
            if (!response.ok) {
                throw new Error('网络响应错误');
            }
            return response.json();
        })
        .then(data => {
            // 隐藏加载动画
            myChart.hideLoading();

            // 检查返回的数据是否包含错误
            if (data.error) {
                console.error("后端返回错误:", data.error);
                alert("加载数据失败: " + data.error);
                return;
            }

            // 5. 定义 ECharts 配置项
            var option = {
                title: {
                    text: '订单来源路径分析',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    triggerOn: 'mousemove'
                },
                series: [
                    {
                        type: 'sankey',
                        layout: 'none',
                        emphasis: {
                            focus: 'adjacency'
                        },
                        // 将从 API 获取的数据填充到这里
                        data: data.nodes,
                        links: data.links,
                        label: {
                            fontSize: 14,
                            color: '#333'
                        },
                        lineStyle: {
                            color: 'source',
                            curveness: 0.5
                        }
                    }
                ]
            };

            // 6. 使用配置项和数据显示图表
            myChart.setOption(option);
        })
        .catch(error => {
            myChart.hideLoading();
            console.error('获取桑基图数据失败:', error);
            alert('获取桑基图数据失败，请检查后端服务是否正常以及网络连接。');
        });

    // 窗口大小改变时，自适应图表
    window.onresize = function () {
        myChart.resize();
    };
</script>
</body>
</html>